#!groovy
// -*- coding: utf-8 -*-

@Library('pipeline_shared_library') _
def libs = pipelineLibraries(this)
def hasChanges = false

pipeline {
    agent any
    options { quietPeriod(0) }

    parameters {
        string(name: 'SERVICE_GROUP', defaultValue: 'sc', description: '서비스 Grooup:sc,subride,subride-front')
        string(name: 'SERVICE_ID', defaultValue: 'config', description: 'Service ID')
        string(name: 'SERVICE_VERSION', defaultValue: '1.0.0', description: 'Service Version')
        string(name: 'NFS_HOST', defaultValue: '43.200.12.214', description: 'NFS Server IP/Host')
        string(name: 'IMAGE_REG_HOST', defaultValue: 'docker.io', description: 'Img Reg Host')
        string(name: 'IMAGE_REG_CREDENTIAL', defaultValue: 'credential_dockerhub_ondal', description: 'Img Reg Credential')
        string(name: 'IMAGE_REG_ORG', defaultValue: 'hiondal', description: 'Img Reg Organization')
        string(name: 'SKIP_STAGES', defaultValue: '', description: 'Stages to skip:sonar,trivy')
    }

    stages {
        // 전역 변수 설정 stage
        stage("Set Global variables") {
            steps {
                script {
                    libs.setGlobalVariables()
                }
            }
        }

        // 환경 준비 stage
        stage("Prepare Environment") {
            steps {
                script {
                    hasChanges = libs.prepareEnvironment()
                }
            }
        }

        // 빌드 및 배포 stage
        stage("Build and Deploy") {
            when { expression { return hasChanges } }   //소스변경시만 수행

            steps {
                script {
                    libs.buildAndDeploy()
                }
            }
        }

        // 최종 완료 stage
        stage("Finalize") {
            steps {
                script {
                    //--소스변경이 없는 경우 성공 처리
                    if (!hasChanges) {
                        currentBuild.result = 'SUCCESS'
                        currentBuild.description = "No pipeline performed because no sources changed"
                    }
                    echo "Finish All processed !!!"
                }
            }
        }
    }
}

