@Library('pipeline_shared_library') _
def libs = pipelineLibraries(this)
def hasChanges = false

properties([
    parameters([
        string(name: 'SERVICE_GROUP', defaultValue: 'sc', description: '서비스 그룹(sc,subride,subride-front)'),
        string(name: 'SERVICE_ID', defaultValue: 'config', description: '서비스 ID(프로젝트명과 동일)'),
        string(name: 'SERVICE_VERSION', defaultValue: '1.0.0', description: '서비스 버전(예:1.0.0)'),
        string(name: 'NFS_HOST', defaultValue: '43.200.12.214', description: 'NFS Server IP 또는 Host'),
        string(name: 'IMAGE_REG_HOST', defaultValue: 'docker.io', description: '이미지저장소 Host'),
        string(name: 'IMAGE_REG_CREDENTIAL', defaultValue: 'credential_dockerhub_ondal', description: '이미지저장소 Credential'),
        string(name: 'IMAGE_REG_ORG', defaultValue: 'hiondal', description: '이미지저장소 Organization'),
        string(name: 'SKIP_STAGES', defaultValue: '', description: '건너 뛸 단계명(sonar,trivy)')
    ])
])

node {
    // 전역 변수 설정
    libs.setGlobalVariables()

    //소스 변경 여부 검사
    hasChanges = libs.checkSourceChanges()

    if (hasChanges) {
        //캐시 디렉토리 생성: gradle library, Trivy image 보안 취약성 기준
        libs.createCacheDirectory()

        // 빌드 및 배포
        libs.buildAndDeploy()
    } else {
        currentBuild.result = 'SUCCESS'
        currentBuild.description = "변경된 소스가 없어 파이프라인 실행 안함"
    }
}


